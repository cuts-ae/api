<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System Test Client</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status.connected { background: #22c55e; }
        .status.disconnected { background: #ef4444; }
        .chat-box { background: white; border-radius: 8px; overflow: hidden; }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: #fafafa; }
        .message { margin-bottom: 15px; }
        .message.sent { text-align: right; }
        .message-content { display: inline-block; padding: 10px 15px; border-radius: 8px; max-width: 70%; }
        .message.received .message-content { background: white; text-align: left; }
        .message.sent .message-content { background: #0084ff; color: white; }
        .message.system .message-content { background: #e3f2fd; color: #1976d2; text-align: center; width: 100%; }
        .message-time { font-size: 11px; color: #999; margin-top: 4px; }
        .typing { padding: 10px 20px; font-style: italic; color: #666; font-size: 14px; }
        .input-area { padding: 20px; border-top: 1px solid #ddd; }
        .input-row { display: flex; gap: 10px; }
        .input-row input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .input-row button { padding: 12px 24px; background: #0084ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .input-row button:disabled { background: #ccc; cursor: not-allowed; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .controls input, .controls button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .controls button { background: #0084ff; color: white; border: none; cursor: pointer; }
        .log { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; max-height: 200px; overflow-y: auto; }
        .log-entry { font-family: monospace; font-size: 12px; padding: 4px; border-bottom: 1px solid #f0f0f0; }
        .log-entry.error { color: #ef4444; }
        .log-entry.success { color: #22c55e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Real-time Chat System Test Client</h1>
            <p><span class="status" id="status"></span><span id="statusText">Disconnected</span></p>
        </div>

        <div class="controls">
            <h3>Connection Settings</h3>
            <div>
                <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:45000">
                <input type="text" id="authToken" placeholder="JWT Token">
                <input type="text" id="sessionId" placeholder="Session ID">
                <button onclick="connect()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="createSession()">Create New Session</button>
                <button onclick="acceptChat()">Accept Chat (Agent)</button>
                <button onclick="closeChat()">Close Chat</button>
            </div>
        </div>

        <div class="chat-box">
            <div class="messages" id="messages"></div>
            <div class="typing" id="typing"></div>
            <div class="input-area">
                <div class="input-row">
                    <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)" oninput="handleTyping()">
                    <button onclick="sendMessage()" id="sendBtn">Send</button>
                </div>
            </div>
        </div>

        <div class="log">
            <h3>Event Log</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let typingTimeout = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        function updateStatus(connected) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusEl.className = 'status ' + (connected ? 'connected' : 'disconnected');
            statusText.textContent = connected ? 'Connected' : 'Disconnected';
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const authToken = document.getElementById('authToken').value;
            const sessionId = document.getElementById('sessionId').value;

            if (!authToken) {
                alert('Please enter JWT token');
                return;
            }

            if (!sessionId) {
                alert('Please enter Session ID');
                return;
            }

            socket = io(serverUrl, {
                auth: { token: authToken },
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                log('Connected to server', 'success');
                updateStatus(true);
                socket.emit('join_session', { session_id: sessionId });
            });

            socket.on('disconnect', () => {
                log('Disconnected from server', 'error');
                updateStatus(false);
            });

            socket.on('session_joined', (data) => {
                log('Session joined successfully', 'success');
                document.getElementById('messages').innerHTML = '';
                data.messages.forEach(msg => addMessage(msg));
            });

            socket.on('new_message', (data) => {
                log('New message received', 'success');
                addMessage(data.message);
            });

            socket.on('user_typing', (data) => {
                document.getElementById('typing').textContent = `${data.user_name || data.user_id} is typing...`;
            });

            socket.on('typing_stopped', (data) => {
                document.getElementById('typing').textContent = '';
            });

            socket.on('messages_read', (data) => {
                log(`Messages read by ${data.user_id}`, 'success');
            });

            socket.on('chat_accepted', (data) => {
                log(`Chat accepted by ${data.agent_name}`, 'success');
            });

            socket.on('chat_closed', (data) => {
                log('Chat closed', 'success');
            });

            socket.on('error', (data) => {
                log(`Error: ${data.message}`, 'error');
                alert(`Error: ${data.message}`);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus(false);
                log('Disconnected', 'info');
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const sessionId = document.getElementById('sessionId').value;

            if (!socket) {
                alert('Not connected');
                return;
            }

            if (!message) return;

            socket.emit('send_message', {
                session_id: sessionId,
                content: message,
                message_type: 'text',
                temp_id: `temp-${Date.now()}`
            });

            input.value = '';
            log(`Sent: ${message}`, 'info');
        }

        function handleTyping() {
            if (!socket) return;

            const sessionId = document.getElementById('sessionId').value;
            socket.emit('typing', { session_id: sessionId });

            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop_typing', { session_id: sessionId });
            }, 3000);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${message.is_system_message ? 'system' : 'received'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message.content;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date(message.created_at).toLocaleTimeString();

            msgDiv.appendChild(contentDiv);
            msgDiv.appendChild(timeDiv);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function createSession() {
            const serverUrl = document.getElementById('serverUrl').value;
            const authToken = document.getElementById('authToken').value;

            if (!authToken) {
                alert('Please enter JWT token');
                return;
            }

            try {
                const response = await fetch(`${serverUrl}/api/v1/chat/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'Test Chat Session',
                        category: 'general',
                        priority: 'medium',
                        initial_message: 'Hello, I need help'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('sessionId').value = data.data.id;
                    log(`Session created: ${data.data.id}`, 'success');
                    alert(`Session created! ID: ${data.data.id}`);
                } else {
                    log(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function acceptChat() {
            if (!socket) {
                alert('Not connected');
                return;
            }

            const sessionId = document.getElementById('sessionId').value;
            socket.emit('accept_chat', { session_id: sessionId });
            log('Accepting chat...', 'info');
        }

        function closeChat() {
            if (!socket) {
                alert('Not connected');
                return;
            }

            const sessionId = document.getElementById('sessionId').value;
            socket.emit('close_chat', { session_id: sessionId });
            log('Closing chat...', 'info');
        }

        updateStatus(false);
    </script>
</body>
</html>
