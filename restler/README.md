# RESTler Security Testing for Cuts.ae API

This directory contains the configuration and setup for Microsoft RESTler, an intelligent REST API fuzzing tool that automatically tests REST APIs for security vulnerabilities and bugs.

## What is RESTler?

RESTler is a stateful REST API fuzzing tool from Microsoft Research that:
- Automatically generates test sequences by analyzing your API specification
- Understands API dependencies (e.g., creating a resource before referencing it)
- Discovers security vulnerabilities, bugs, and unexpected behaviors
- Performs intelligent fuzzing with various security checkers
- Generates detailed bug reports and logs

## Directory Structure

```
restler/
├── README.md              # This file
├── openapi.yaml          # OpenAPI 3.0 specification of the Cuts.ae API
├── config.json           # RESTler configuration with fuzzing parameters
├── setup.sh              # Installation script for RESTler and dependencies
├── run-restler.sh        # Execution script for running fuzzing tests
├── get_token.py          # Authentication token generator (created by setup)
├── .env.restler          # Environment template (created by setup)
├── .env.restler.local    # Custom environment (create this for overrides)
├── Compile/              # Grammar compilation output
├── Test/                 # Test mode results
├── FuzzLean/             # Fuzzing results and bug reports
└── Logs/                 # Execution logs
```

## Quick Start

### 1. Installation

Run the setup script to install RESTler and its dependencies:

```bash
cd /Users/sour/Projects/cuts.ae/api/restler
./setup.sh
```

This will:
- Install .NET SDK (required for RESTler)
- Install Python 3 and dependencies
- Download and install RESTler
- Set up directory structure
- Create authentication helper scripts

### 2. Start the API Server

Ensure your API server is running before fuzzing:

```bash
cd /Users/sour/Projects/cuts.ae/api
npm run dev
```

The API should be accessible at `http://localhost:45000`

### 3. Run Fuzzing Tests

Execute the fuzzing script:

```bash
cd /Users/sour/Projects/cuts.ae/api/restler
./run-restler.sh
```

This will:
1. Compile the OpenAPI specification into RESTler grammar
2. Run test mode to validate the API
3. Execute intelligent fuzzing based on configuration

## Usage

### Basic Commands

```bash
# Full run with default settings (1 hour fuzzing)
./run-restler.sh

# Clean previous results and run
./run-restler.sh --clean

# Compile only (no fuzzing)
./run-restler.sh --compile-only

# Skip compilation and fuzz with existing grammar
./run-restler.sh --skip-compile

# Test only (validate API without fuzzing)
./run-restler.sh --test-only

# Specify fuzzing mode
./run-restler.sh --mode bfs
./run-restler.sh --mode random-walk

# Get help
./run-restler.sh --help
```

### Fuzzing Modes

RESTler supports different fuzzing strategies:

- **directed-smoke-test** (default): Fast, directed testing focused on finding bugs quickly
- **bfs**: Breadth-first search, systematically explores all paths
- **bfs-cheap**: Lighter version of BFS with fewer combinations
- **random-walk**: Random exploration of API endpoints

### Environment Configuration

Create `.env.restler.local` to customize settings:

```bash
cp .env.restler .env.restler.local
```

Then edit `.env.restler.local`:

```bash
# API Configuration
API_URL=http://localhost:45000/api/v1

# Test User Credentials (used for authenticated requests)
RESTLER_TEST_EMAIL=test@cuts.ae
RESTLER_TEST_PASSWORD=TestPassword123!

# RESTler Execution Settings
RESTLER_TIME_BUDGET=3600          # Fuzzing duration in seconds
RESTLER_MAX_SEQUENCE_LENGTH=100   # Maximum test sequence length
RESTLER_TARGET_PORT=45000         # API port
```

## Configuration Files

### openapi.yaml

Complete OpenAPI 3.0 specification including:
- All API endpoints (auth, restaurants, menu, orders, admin, support, chat)
- Request/response schemas with validation rules
- Authentication requirements (JWT Bearer tokens)
- Error responses and status codes

This file is automatically generated based on your route definitions and validators.

### config.json

RESTler configuration including:

**Grammar Compilation Settings:**
- `IncludeOptionalParameters`: Include optional parameters in fuzzing
- `UseBodyExamples`: Use example values from OpenAPI spec
- `DataFuzzing`: Enable intelligent data fuzzing

**Custom Dictionary:**
- Predefined values for common fields (emails, passwords, UUIDs)
- Valid enum values for status, role, category fields
- UAE-specific test data (phone numbers, addresses)

**Security Checkers:**
- `useafterfree`: Detects use-after-free vulnerabilities
- `leakagerule`: Identifies resource leaks
- `resourcehierarchy`: Validates resource dependencies
- `payloadbody`: Tests payload injection attacks
- `invaliddynamicobject`: Checks for SSRF and similar issues

**Performance Settings:**
- `max_sequence_length`: Maximum length of request sequences
- `time_budget`: Total fuzzing time in seconds
- `request_throttle_ms`: Delay between requests
- `max_concurrent_requests`: Number of parallel requests

## Interpreting Results

### Successful Run

After completion, you'll see a summary like:

```
==========================================
Fuzzing Summary
==========================================

Results directory: FuzzLean/RestlerResults/experiment12345/

No bugs found!

Total requests sent: 2500

Response Status Summary:
  500 Internal Server Error: 0
  400 Bad Request: 45
  401 Unauthorized: 120
  403 Forbidden: 30
  404 Not Found: 15

==========================================
RESTler fuzzing complete!
==========================================
```

### Bug Discovery

If bugs are found, you'll see:

```
Found 3 bug bucket(s)!

Bug buckets found in: FuzzLean/RestlerResults/experiment12345/bug_buckets/
-rw-r--r--  1 user  staff  2.1K  bug_bucket_1.txt
-rw-r--r--  1 user  staff  3.4K  bug_bucket_2.txt
-rw-r--r--  1 user  staff  1.8K  bug_bucket_3.txt

To investigate bugs:
  cd FuzzLean/RestlerResults/experiment12345/bug_buckets/
  cat *.txt
```

### Analyzing Bug Reports

Bug bucket files contain:
- **Request sequence**: The exact sequence of API calls that triggered the bug
- **Response details**: Status codes, headers, and body
- **Checker information**: Which security checker detected the issue
- **Reproduction steps**: How to manually reproduce the bug

Example bug report structure:

```
Bug Bucket: InvalidDynamicObject
Checker: useafterfree

Request Sequence:
1. POST /api/v1/restaurants
   Status: 201 Created
   Response: {"id": "abc-123", ...}

2. DELETE /api/v1/restaurants/abc-123
   Status: 200 OK

3. GET /api/v1/restaurants/abc-123/analytics
   Status: 200 OK  <-- BUG: Resource accessed after deletion
   Response: {...}
```

### Log Files

Key log files in the results directory:

- **logs/main.txt**: Main execution log with all requests and responses
- **logs/network.testing.*.txt**: Network-level request/response logs
- **logs/specdiff.json**: Differences between spec and actual behavior
- **logs/testing_summary.json**: Test execution statistics
- **bug_buckets/*.txt**: Detailed bug reports

### Response Code Analysis

**Expected responses:**
- 200/201: Successful operations
- 400: Validation errors (expected for malformed requests)
- 401: Authentication required (expected for protected endpoints)
- 403: Forbidden (expected for insufficient permissions)
- 404: Not found (expected for invalid IDs)

**Potential issues:**
- 500: Internal server error - should be investigated
- Unexpected 200s: Resources accessible when they shouldn't be
- Missing authentication checks: 200 instead of 401
- Missing authorization checks: 200 instead of 403

## Common Issues and Troubleshooting

### API Server Not Running

```
Error: API server is not responding at http://localhost:45000
```

**Solution:** Start the API server first:
```bash
cd /Users/sour/Projects/cuts.ae/api
npm run dev
```

### RESTler Not Installed

```
Error: RESTler is not installed
```

**Solution:** Run the setup script:
```bash
./setup.sh
```

### Compilation Errors

If grammar compilation fails:

1. Validate OpenAPI spec:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('openapi.yaml'))"
   ```

2. Check for syntax errors in openapi.yaml
3. Ensure all required fields are present
4. Verify schema references are correct

### Authentication Issues

If authenticated requests fail:

1. Verify test user credentials in `.env.restler.local`
2. Test authentication manually:
   ```bash
   python3 get_token.py
   ```
3. Check API authentication middleware
4. Ensure JWT_SECRET is set in API environment

### High Memory Usage

RESTler can consume significant memory during fuzzing:

- Reduce `max_sequence_length` in config.json
- Use `bfs-cheap` mode instead of `bfs`
- Reduce `time_budget` for shorter runs
- Close other applications

### Slow Performance

To speed up fuzzing:

- Reduce `request_throttle_ms` in config.json
- Increase `max_concurrent_requests` (use with caution)
- Use `directed-smoke-test` mode instead of `bfs`
- Focus on specific endpoints using path_regex in config

## Best Practices

### Regular Testing Schedule

- **Weekly**: Run directed-smoke-test (1 hour)
- **Before releases**: Run full BFS (4-8 hours)
- **After major changes**: Run targeted tests on affected endpoints

### Development Workflow

1. Make API changes
2. Update openapi.yaml if endpoints changed
3. Run quick smoke test:
   ```bash
   ./run-restler.sh --clean --mode directed-smoke-test
   ```
4. Review and fix any bugs found
5. Run full test before committing

### Continuous Integration

While RESTler tests are too slow for regular CI, consider:

- Running nightly fuzzing tests
- Using directed-smoke-test in PR pipelines (10-15 minutes)
- Storing results for trend analysis
- Alerting on new bugs discovered

### Test Data Management

- Keep test credentials separate from production
- Use dedicated test database
- Clean up test data after runs
- Don't commit `.env.restler.local` with secrets

## Security Checkers Explained

### Use After Free
Detects when a deleted resource is still accessible:
```
DELETE /restaurants/123  (200 OK)
GET /restaurants/123     (200 OK - BUG!)
```

### Resource Leakage
Identifies resources that aren't properly cleaned up:
```
POST /orders (create many orders)
DELETE /orders/* (some deletions fail)
GET /orders (orphaned resources remain)
```

### Resource Hierarchy
Validates parent-child relationships:
```
DELETE /restaurants/123
GET /restaurants/123/menu-items (should fail)
```

### Invalid Dynamic Object
Checks for injection attacks and SSRF:
```
POST /restaurants
  body: {"owner_id": "../admin/secrets"}
```

### Payload Body
Tests for various payload injection attacks:
- SQL injection attempts
- NoSQL injection attempts
- Command injection
- Path traversal

### Namespace Rule
Ensures proper resource isolation:
```
User A creates resource
User B shouldn't access User A's resource
```

## Advanced Configuration

### Custom Dictionary Values

Add custom test values to `config.json`:

```json
"CustomDictionary": {
  "restler_custom_payload": {
    "custom_field": ["value1", "value2", "value3"]
  }
}
```

### Per-Resource Settings

Configure specific behavior for endpoints:

```json
"per_resource_settings": {
  "/api/v1/custom/endpoint": {
    "producer_timing_delay": 5,
    "create_once": true
  }
}
```

### Checker Configuration

Customize checker behavior:

```json
"CheckerOptions": {
  "InvalidDynamicObjectChecker": {
    "InvalidValueChecker": {
      "strictSSRF": true,
      "checkSQLInjection": true
    }
  }
}
```

## Integration with npm Scripts

The package.json includes a convenient script:

```bash
# Run RESTler fuzzing
npm run test:restler
```

This executes the fuzzing tests without having to cd into the restler directory.

## Resources

### Documentation
- [RESTler GitHub](https://github.com/microsoft/restler-fuzzer)
- [RESTler Documentation](https://github.com/microsoft/restler-fuzzer/tree/main/docs)
- [OpenAPI Specification](https://swagger.io/specification/)

### Research Papers
- [RESTler: Stateful REST API Fuzzing](https://www.microsoft.com/en-us/research/publication/restler-stateful-rest-api-fuzzing/)
- [Intelligent REST API Data Fuzzing](https://www.microsoft.com/en-us/research/publication/intelligent-rest-api-data-fuzzing/)

### Getting Help
- Review logs in the experiment directory
- Check GitHub issues for similar problems
- Validate OpenAPI spec with online validators
- Test API manually to reproduce issues

## Notes

- RESTler tests are NOT part of regular CI due to execution time (30+ minutes)
- Tests are designed to be run manually or on a schedule
- Results should be reviewed and bugs fixed promptly
- Keep OpenAPI spec synchronized with actual API implementation
- Regular fuzzing helps catch security issues before production

## License

RESTler is licensed under the MIT License by Microsoft Corporation.

## Contributing

To update the RESTler configuration:

1. Modify OpenAPI spec (openapi.yaml) when API changes
2. Update custom dictionary values as needed
3. Adjust fuzzing parameters based on findings
4. Document any new security issues discovered
5. Share improvements with the team

---

Last updated: 2025-11-21
